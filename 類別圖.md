# 量化交易系統類別圖

## 系統架構概覽

本文件描述量化交易系統的類別架構，展示系統中各個類別的職責與關係。

## 類別圖

```mermaid
classDiagram
    class 啟動入口 {
        <<職責>>
        負責系統初始化與啟動主程式
    }
    
    class 主程式 {
        <<職責>>
        負責控制整個交易流程的協調與管理
    }
    
    class Login {
        <<登入>>
        -sj: Optional[Shioaji]
        +login(api_key: str, secret_key: str) Shioaji
        +is_logged_in() bool
        +logout() None
        --
        負責使用者驗證與身份認證
        保存 Shioaji API 物件供後續使用
    }
    
    class ContractManager {
        <<取得商品檔>>
        -_api: Shioaji
        -contracts: Optional[Any]
        +fetch_contracts(contract_download: bool, timeout: int) Any
        +get_stock(stock_code: str) Optional[Any]
        +get_future(future_code: str) Optional[Any]
        +get_all_stocks() Dict[str, Any]
        +is_contracts_ready() bool
        --
        負責獲取可交易的商品資訊
        包含證券、期貨、選擇權和指數
    }
    
    class QuoteSubscriber {
        <<訂閱報價>>
        -_api: Shioaji
        -_subscribed_contracts: List[Any]
        +subscribe(contract: Any, quote_type: str, version: str) bool
        +unsubscribe(contract: Any) bool
        +get_subscribed_contracts() List[Any]
        +is_subscribed(contract: Any) bool
        --
        負責訂閱即時市場報價
        支援股票、期貨等商品的即時報價訂閱
    }
    
    class QuoteCallback {
        <<報價回調處理>>
        -_api: Shioaji
        -_quote_callbacks: List[Callable]
        -_order_callbacks: List[Callable]
        -_latest_quotes: Dict[str, Any]
        +set_quote_callback(callback: Callable) None
        +set_order_callback(callback: Callable) None
        +get_latest_quote(code: str) Optional[Dict]
        +get_all_latest_quotes() Dict[str, Dict]
        +clear_callbacks() None
        --
        負責處理接收到的報價資料
        提供自訂回調函數的註冊與管理
    }
    
    class 下單 {
        <<職責>>
        負責執行交易訂單
    }
    
    class 取得成交回報 {
        <<職責>>
        負責獲取已成交訂單資訊
    }
    
    class 取得委託回報 {
        <<職責>>
        負責獲取委託訂單狀態
    }
    
    class 取得帳戶餘額已實現未實現損益 {
        <<職責>>
        負責獲取帳戶餘額與損益資訊
    }
    
    class 策略數據準備 {
        <<職責>>
        負責準備策略所需的市場數據
    }
    
    class 策略 {
        <<職責>>
        負責實現交易策略邏輯與決策
    }
    
    class MarketScanner {
        <<市場交易狀況排行>>
        -_api: Shioaji
        -_last_scan_result: Optional[List[Any]]
        -_last_scan_time: Optional[datetime]
        +get_change_percent_rank(count: int, ascending: bool, date: str, timeout: int) List[Any]
        +get_change_price_rank(count: int, ascending: bool, date: str, timeout: int) List[Any]
        +get_volume_rank(count: int, ascending: bool, date: str, timeout: int) List[Any]
        +get_amount_rank(count: int, ascending: bool, date: str, timeout: int) List[Any]
        +get_day_range_rank(count: int, ascending: bool, date: str, timeout: int) List[Any]
        +get_last_scan_result() Optional[List[Any]]
        +get_last_scan_time() Optional[datetime]
        --
        負責匯總和展示當前交易狀況
        提供漲跌幅、成交量、成交金額等排行查詢
    }
    
    %% 系統啟動與控制流程
    啟動入口 --> 主程式
    
    %% 主程式協調各個模組
    主程式 --> Login
    主程式 --> ContractManager
    主程式 --> QuoteSubscriber
    主程式 --> QuoteCallback
    主程式 --> 策略
    主程式 --> 下單
    主程式 --> MarketScanner
    
    %% Login 與其他模組的依賴關係
    Login --> ContractManager : 提供 API 物件
    Login --> QuoteSubscriber : 提供 API 物件
    Login --> QuoteCallback : 提供 API 物件
    Login --> MarketScanner : 提供 API 物件
    
    %% 報價處理流程
    ContractManager --> QuoteSubscriber : 提供商品合約
    QuoteSubscriber --> QuoteCallback : 觸發回調
    QuoteCallback --> 策略數據準備 : 傳遞報價資料
    
    %% 策略執行流程
    策略數據準備 --> 策略
    策略 --> 下單
    
    %% 訂單與帳戶管理
    下單 --> 取得委託回報
    下單 --> 取得成交回報
    取得成交回報 --> 取得帳戶餘額已實現未實現損益
    
    %% 交易狀況監控
    取得帳戶餘額已實現未實現損益 --> MarketScanner : 提供帳戶資訊
    取得委託回報 --> MarketScanner : 提供委託資訊
    策略 --> MarketScanner : 查詢市場排行
```

## 類別職責說明

| 類別名稱 | 職責描述 | 實作狀態 |
|---------|---------|----------|
| 啟動入口 | 負責系統初始化與啟動主程式 | 待實作 |
| 主程式 | 負責控制整個交易流程的協調與管理 | 待實作 |
| Login | 負責使用者驗證與身份認證，保存 Shioaji API 物件供後續使用 | ✅ 已實作 |
| ContractManager | 負責獲取可交易的商品資訊，包含證券、期貨、選擇權和指數 | ✅ 已實作 |
| QuoteSubscriber | 負責訂閱即時市場報價，支援股票、期貨等商品的即時報價訂閱 | ✅ 已實作 |
| QuoteCallback | 負責處理接收到的報價資料，提供自訂回調函數的註冊與管理 | ✅ 已實作 |
| 下單 | 負責執行交易訂單 | 待實作 |
| 取得成交回報 | 負責獲取已成交訂單資訊 | 待實作 |
| 取得委託回報 | 負責獲取委託訂單狀態 | 待實作 |
| 取得帳戶餘額已實現未實現損益 | 負責獲取帳戶餘額與損益資訊 | 待實作 |
| 策略數據準備 | 負責準備策略所需的市場數據 | 待實作 |
| 策略 | 負責實現交易策略邏輯與決策 | 待實作 |
| MarketScanner | 負責匯總和展示當前交易狀況，提供漲跌幅、成交量、成交金額等排行查詢 | ✅ 已實作 |

## 系統流程說明

1. **系統啟動**：啟動入口初始化並啟動主程式
2. **身份驗證**：主程式呼叫登入模組進行身份認證
3. **數據獲取**：取得商品檔資訊並訂閱市場報價
4. **報價處理**：報價Callback接收數據並傳遞給策略數據準備模組
5. **策略執行**：策略模組根據準備好的數據做出交易決策
6. **訂單執行**：下單模組執行交易指令
7. **狀態監控**：取得委託回報與成交回報，更新帳戶資訊
8. **狀況摘要**：摘要模組整合所有資訊並展示當前交易狀況
