# 永豐金證券股票回測系統 - 類別圖

## 系統類別結構

```mermaid
classDiagram
    class LoginCredentials {
        +str person_id
        +str passwd
        +__post_init__()
    }
    
    class AuthenticationService {
        -Shioaji _api
        -bool _is_logged_in
        +__init__(api: Shioaji)
        +login(credentials: LoginCredentials, contracts_cb: Callable, subscribe_trade: bool, contracts_timeout: int) bool
        +logout() bool
        +is_logged_in: bool
    }
    
    class SinotradeClient {
        -Shioaji _api
        -AuthenticationService _auth_service
        +__init__(simulation: bool, log_level: str)
        +login(person_id: str, passwd: str, subscribe_trade: bool, contracts_timeout: int) bool
        +logout() bool
        +list_accounts() List~Account~
        +set_default_account(account: Account)
        +stock_account: StockAccount
        +futopt_account: FutureAccount
        +is_logged_in: bool
        +api: Shioaji
    }
    
    class DateRange {
        +str start_date
        +str end_date
        +__post_init__()
    }
    
    class MarketDataFetcher {
        -Shioaji _api
        +__init__(api: Shioaji)
        +get_all_stock_symbols() List~str~
        +fetch_stock_kbars(stock_code: str, date_range: DateRange) DataFrame
        +fetch_multiple_stocks_kbars(stock_codes: List~str~, date_range: DateRange, skip_errors: bool) DataFrame
        +fetch_all_market_kbars(date_range: DateRange, skip_errors: bool) DataFrame
    }
    
    class BigQueryStorage {
        -BigQueryClient _client
        -str _project_id
        -str _dataset_id
        -str _table_id
        +__init__(project_id: str, dataset_id: str, table_id: str, credentials_path: str)
        +table_ref: str
        +create_table_if_not_exists()
        +insert_dataframe(df: DataFrame, write_disposition: str) int
        +query_data(query: str) DataFrame
    }
    
    class DataValidator {
        -BigQueryStorage _storage
        +__init__(storage: BigQueryStorage)
        +check_data_exists(stock_code: str, start_date: str, end_date: str) bool
        +get_missing_dates(stock_code: str, start_date: str, end_date: str, expected_trading_days: List~str~) List~str~
        +validate_data_quality(stock_code: str) Dict
        +get_data_summary() Dict
    }
    
    class Shioaji {
        <<external>>
        +login()
        +logout()
        +list_accounts()
        +set_default_account()
        +kbars()
        +Contracts
    }
    
    class BigQueryClient {
        <<external>>
        +create_table()
        +load_table_from_dataframe()
        +query()
    }
    
    class Account {
        <<external>>
        +str account_id
        +str person_id
    }
    
    class StockAccount {
        <<external>>
    }
    
    class FutureAccount {
        <<external>>
    }
    
    %% 認證模組關係
    SinotradeClient --> AuthenticationService : 使用
    SinotradeClient --> Shioaji : 依賴
    AuthenticationService --> Shioaji : 依賴
    AuthenticationService --> LoginCredentials : 使用
    SinotradeClient ..> Account : 返回
    SinotradeClient ..> StockAccount : 返回
    SinotradeClient ..> FutureAccount : 返回
    StockAccount --|> Account : 繼承
    FutureAccount --|> Account : 繼承
    
    %% 市場資料模組關係
    MarketDataFetcher --> Shioaji : 依賴
    MarketDataFetcher --> DateRange : 使用
    
    %% BigQuery 模組關係
    BigQueryStorage --> BigQueryClient : 依賴
    DataValidator --> BigQueryStorage : 使用
```

## 類別職責說明

### LoginCredentials（登入憑證）
**職責**：封裝使用者登入所需的憑證資訊
- 儲存身份證字號和密碼
- 驗證憑證資料的有效性
- 確保資料完整性

### AuthenticationService（認證服務）
**職責**：專門處理帳號認證相關的操作
- 管理使用者登入狀態
- 執行登入和登出操作
- 驗證登入憑證
- 追蹤登入狀態

### SinotradeClient（永豐金證券客戶端）
**職責**：提供永豐金證券 API 的主要操作介面
- 管理 API 連線
- 提供高層級的 API 操作介面
- 整合認證服務
- 管理帳號資訊（證券帳號、期貨帳號）
- 提供合約查詢功能

### Shioaji（外部 API）
**職責**：永豐金證券官方提供的 Python API
- 提供底層的交易功能
- 處理與永豐金證券伺服器的通訊

### Account / StockAccount / FutureAccount（帳號類別）
**職責**：代表不同類型的交易帳號
- Account：基礎帳號類別
- StockAccount：證券交易帳號
- FutureAccount：期貨交易帳號

### DateRange（日期區間）
**職責**：封裝日期區間資訊
- 儲存開始和結束日期
- 驗證日期格式和邏輯正確性
- 確保開始日期不晚於結束日期

### MarketDataFetcher（市場資料抓取器）
**職責**：從永豐金證券 API 抓取股票歷史交易資料
- 取得全市場股票代碼列表
- 抓取單一或多支股票的 K 線資料
- 將資料轉換為 DataFrame 格式
- 處理資料抓取過程中的錯誤

### BigQueryStorage（BigQuery 儲存服務）
**職責**：管理 BigQuery 資料的存取
- 建立和管理 BigQuery 資料表
- 將 DataFrame 資料上傳到 BigQuery
- 執行 SQL 查詢並返回結果
- 設定資料表分區和叢集

### DataValidator（資料驗證器）
**職責**：驗證 BigQuery 中的資料完整性和品質
- 檢查指定日期範圍的資料是否存在
- 驗證資料筆數是否合理
- 檢查是否有缺失的股票或日期
- 驗證資料品質（如價格、成交量的合理性）

## 設計原則

### 單一職責原則（SRP）
- `LoginCredentials`：只負責封裝和驗證登入憑證
- `AuthenticationService`：只負責認證相關功能
- `SinotradeClient`：只負責提供客戶端操作介面
- `DateRange`：只負責封裝和驗證日期區間
- `MarketDataFetcher`：只負責抓取市場資料
- `BigQueryStorage`：只負責 BigQuery 資料存取
- `DataValidator`：只負責資料驗證

### 依賴反轉原則（DIP）
- `SinotradeClient` 依賴 `AuthenticationService` 抽象，而非具體實作
- `DataValidator` 依賴 `BigQueryStorage`，可以輕鬆替換儲存實作
- 使用組合而非繼承，降低耦合度

### 開放封閉原則（OCP）
- 各類別設計允許擴展但不需修改現有程式碼
- 使用屬性裝飾器提供靈活的存取介面
- 透過參數配置支援不同的使用場景

### 介面隔離原則（ISP）
- `MarketDataFetcher` 提供多個專門的方法，使用者可選擇需要的功能
- `DataValidator` 提供獨立的驗證方法，不強制使用所有功能
