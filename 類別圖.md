# 量化交易系統 - 類別圖

## Shioaji 連線管理模組類別圖

本文件展示量化交易系統中 Shioaji 連線管理模組的類別結構與關係。

### 主要類別圖

```mermaid
classDiagram
    class ShioajiConnector {
        -str api_key
        -str secret_key
        -bool simulation
        +Shioaji sj
        +bool is_connected
        +datetime login_time
        +Logger logger
        
        +__init__(api_key: str, secret_key: str, simulation: bool)
        -_initialize_api() None
        +login(person_id: str, passwd: str, ca_path: str, ca_passwd: str, fetch_contract: bool) bool
        -_activate_ca(ca_path: str, ca_passwd: str) None
        +logout() bool
        +get_connection_status() Dict
        +__enter__() ShioajiConnector
        +__exit__(exc_type, exc_val, exc_tb) bool
        +__repr__() str
    }
    
    class Shioaji {
        <<external library>>
        +person_id: str
        +login(api_key, secret_key, person_id, passwd, fetch_contract)
        +activate_ca(ca_path, ca_passwd, person_id)
        +logout()
    }
    
    class Logger {
        <<standard library>>
        +info(msg: str)
        +warning(msg: str)
        +error(msg: str)
    }
    
    ShioajiConnector --> Shioaji : 依賴
    ShioajiConnector --> Logger : 使用
    
    note for ShioajiConnector "主要職責：\n1. 管理與永豐金證券API的連線\n2. 處理登入/登出流程\n3. 管理憑證認證\n4. 提供連線狀態查詢\n\n設計原則：\n- 單一職責原則(SRP)\n- 依賴反轉原則(DIP)\n- 開放封閉原則(OCP)"
```

### 類別詳細說明

#### ShioajiConnector (Shioaji 連線器)

**職責：**
- 管理與永豐金證券 Shioaji API 的連線生命週期
- 封裝登入、登出、憑證認證等操作
- 提供連線狀態查詢功能
- 支援 Context Manager 模式 (with 語句)

**設計模式：**
- **Facade Pattern (外觀模式)**：簡化 Shioaji API 的複雜介面
- **Context Manager Pattern**：支援資源自動管理

**SOLID 原則體現：**
1. **單一職責原則 (SRP)**：專注於連線管理，不處理交易邏輯
2. **開放封閉原則 (OCP)**：可透過繼承擴展功能，無需修改原有程式碼
3. **依賴反轉原則 (DIP)**：依賴於 Shioaji 抽象介面，而非具體實作

---

### 時序圖：登入流程

```mermaid
sequenceDiagram
    participant User as 使用者
    participant Connector as ShioajiConnector
    participant API as Shioaji API
    participant Logger as Logger
    
    User->>Connector: __init__(api_key, secret_key)
    Connector->>API: 建立 Shioaji 實例
    Connector->>Logger: 記錄初始化成功
    
    User->>Connector: login(person_id, passwd)
    Connector->>Connector: 驗證參數
    Connector->>API: login(credentials)
    API-->>Connector: 返回帳戶資訊
    Connector->>Connector: 更新連線狀態
    Connector->>Logger: 記錄登入成功
    Connector-->>User: 返回 True
    
    opt 如果提供憑證
        Connector->>API: activate_ca(ca_path, ca_passwd)
        API-->>Connector: 憑證啟用成功
        Connector->>Logger: 記錄憑證啟用
    end
```

---

### 狀態圖：連線狀態管理

```mermaid
stateDiagram-v2
    [*] --> 未初始化
    未初始化 --> 已初始化: __init__()
    已初始化 --> 已連線: login() 成功
    已初始化 --> 登入失敗: login() 失敗
    登入失敗 --> 已初始化: 重試
    已連線 --> 已初始化: logout()
    已連線 --> [*]: __exit__()
    
    note right of 已連線
        此狀態下可以：
        - 查詢帳戶資訊
        - 查詢市場資料
        - 執行交易（需憑證）
    end note
```

---

### 使用案例圖

```mermaid
graph TB
    subgraph 量化交易系統
        A[ShioajiConnector<br/>連線管理器]
    end
    
    subgraph 核心功能
        B[登入管理]
        C[憑證認證]
        D[連線監控]
        E[資源釋放]
    end
    
    subgraph 外部依賴
        F[Shioaji API<br/>永豐金證券]
        G[日誌系統<br/>Logger]
    end
    
    A --> B
    A --> C
    A --> D
    A --> E
    
    B --> F
    C --> F
    D --> G
    E --> F
    E --> G
    
    style A fill:#4CAF50,stroke:#2E7D32,color:#fff
    style F fill:#2196F3,stroke:#1565C0,color:#fff
    style G fill:#FF9800,stroke:#E65100,color:#fff
```

---

### 模組便利函數

```mermaid
graph LR
    A[create_connector] -->|建立| B[ShioajiConnector]
    A -->|參數| C[api_key]
    A -->|參數| D[secret_key]
    A -->|參數| E[simulation]
    
    style A fill:#9C27B0,stroke:#6A1B9A,color:#fff
    style B fill:#4CAF50,stroke:#2E7D32,color:#fff
```

---

## 設計特點總結

### 1. 符合 SOLID 原則
- ✅ **S (Single Responsibility)**：單一職責，專注連線管理
- ✅ **O (Open/Closed)**：開放擴展，封閉修改
- ✅ **L (Liskov Substitution)**：可被子類別替換
- ✅ **I (Interface Segregation)**：介面精簡，方法職責明確
- ✅ **D (Dependency Inversion)**：依賴抽象而非具體實作

### 2. 良好的錯誤處理
- 所有公開方法都有完整的錯誤處理
- 使用自訂異常提供清晰的錯誤訊息
- 完整的日誌記錄便於問題追蹤

### 3. 完整的文件
- 每個方法都有詳細的 docstring
- 包含參數說明、返回值、異常、使用範例
- 符合 Python 文件規範

### 4. 易用性設計
- 支援 Context Manager (with 語句)
- 提供便利函數 `create_connector`
- 清晰的狀態管理和查詢介面

### 5. 可測試性
- 職責單一，易於單元測試
- 依賴注入設計，便於 Mock
- 清晰的狀態轉換邏輯

---

## 未來擴展方向

```mermaid
graph TB
    A[ShioajiConnector<br/>當前實作] --> B[訂單管理器<br/>OrderManager]
    A --> C[帳戶管理器<br/>AccountManager]
    A --> D[市場資料管理器<br/>MarketDataManager]
    A --> E[策略執行器<br/>StrategyExecutor]
    
    B --> F[交易系統整合<br/>Trading System]
    C --> F
    D --> F
    E --> F
    
    style A fill:#4CAF50,stroke:#2E7D32,color:#fff
    style F fill:#FF5722,stroke:#D84315,color:#fff
```

---

**文件版本：** 1.0  
**建立日期：** 2025-10-06  
**作者：** Trading System Team  
**最後更新：** 2025-10-06
