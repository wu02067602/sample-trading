# 量化交易系統 - 類別圖

## Shioaji 連線管理模組類別圖

本文件展示量化交易系統中 Shioaji 連線管理模組的類別結構與關係。

### 主要類別圖

```mermaid
classDiagram
    class ShioajiConnector {
        -str api_key
        -str secret_key
        -bool simulation
        +Shioaji sj
        +bool is_connected
        +datetime login_time
        +Contracts contracts
        +Dict subscribed_contracts
        +Dict quote_callbacks
        +Dict quote_data
        +Dict order_callbacks
        +List orders_history
        +List deal_callbacks
        +List order_update_callbacks
        +List deals_history
        +List order_updates
        +Logger logger
        
        +__init__(api_key: str, secret_key: str, simulation: bool)
        -_initialize_api() None
        +login(person_id: str, passwd: str, ca_path: str, ca_passwd: str, fetch_contract: bool) bool
        -_activate_ca(ca_path: str, ca_passwd: str) None
        +logout() bool
        +get_connection_status() Dict
        +get_contracts() Contracts
        +search_stock(keyword: str) List
        +get_stock_by_code(code: str) Contract
        +search_futures(keyword: str) List
        +get_contracts_summary() Dict
        +subscribe_quote(contract: Any, quote_type: str) bool
        +unsubscribe_quote(contract: Any) bool
        +set_quote_callback(callback: Callable, event_type: str) None
        +get_subscribed_contracts() Dict
        +get_latest_quote(code: str) Dict
        +clear_quote_callbacks(event_type: str) None
        +place_order(contract: Any, action: str, price: float, quantity: int, order_type: str, price_type: str, odd_lot: bool) Trade
        +cancel_order(trade: Any) bool
        +update_order(trade: Any, price: float, quantity: int) Trade
        +list_positions() List
        +list_trades() List
        +get_orders_history() List
        +set_order_callback(callback: Callable) None
        +set_deal_callback(callback: Callable) None
        +get_deals_history() List
        +get_order_updates() List
        +__enter__() ShioajiConnector
        +__exit__(exc_type, exc_val, exc_tb) bool
        +__repr__() str
    }
    
    class Shioaji {
        <<external library>>
        +person_id: str
        +Contracts Contracts
        +Quote quote
        +Account stock_account
        +login(api_key, secret_key, person_id, passwd, fetch_contract)
        +activate_ca(ca_path, ca_passwd, person_id)
        +logout()
        +on_tick_stk_v1(callback)
        +on_bidask_stk_v1(callback)
        +place_order(contract, order)
        +cancel_order(trade)
        +update_order(trade, price, qty)
        +list_positions()
        +list_trades()
        +on_order_status(callback)
        +on_deal(callback)
    }
    
    class Quote {
        <<external library>>
        +subscribe(contract, quote_type, version)
        +unsubscribe(contract, quote_type, version)
    }
    
    class Order {
        <<external library>>
        +price: float
        +quantity: int
        +action: Action
        +price_type: PriceType
        +order_type: OrderType
        +order_lot: OrderLot
        +account: Account
    }
    
    class Trade {
        <<external library>>
        +order: Order
        +status: Status
        +contract: Contract
    }
    
    class Contracts {
        <<external library>>
        +Stocks: List~Contract~
        +Futures: List~Contract~
        +Options: List~Contract~
    }
    
    class Contract {
        <<external library>>
        +code: str
        +name: str
        +exchange: str
        +category: str
    }
    
    class Logger {
        <<standard library>>
        +info(msg: str)
        +warning(msg: str)
        +error(msg: str)
    }
    
    ShioajiConnector --> Shioaji : 依賴
    ShioajiConnector --> Contracts : 管理
    ShioajiConnector --> Trade : 處理
    ShioajiConnector --> Logger : 使用
    Shioaji --> Contracts : 提供
    Shioaji --> Quote : 包含
    Shioaji --> Order : 建立
    Contracts --> Contract : 包含
    Trade --> Order : 包含
    Trade --> Contract : 關聯
    
    note for ShioajiConnector "主要職責：\n1. 管理與永豐金證券API的連線\n2. 處理登入/登出流程\n3. 管理憑證認證\n4. 提供連線狀態查詢\n5. 管理商品檔資料\n6. 提供商品查詢功能\n7. 管理報價訂閱 (v3.0)\n8. 處理 Callback 事件 (v3.0)\n9. 執行證券下單 (v4.0)\n10. 管理訂單與持股 (v4.0)\n11. 處理成交回報 (v4.1)\n12. 監控訂單狀態 (v4.1)\n\n設計原則：\n- 單一職責原則(SRP)\n- 依賴反轉原則(DIP)\n- 開放封閉原則(OCP)"
```

### 類別詳細說明

#### ShioajiConnector (Shioaji 連線器)

**職責：**
- 管理與永豐金證券 Shioaji API 的連線生命週期
- 封裝登入、登出、憑證認證等操作
- 提供連線狀態查詢功能
- **管理商品檔資料（v2.0）**
- **提供股票、期貨等商品查詢功能（v2.0）**
- **管理即時報價訂閱（v3.0）**
- **處理 Callback 事件回調（v3.0）**
- **執行證券買賣下單（v4.0）**
- **管理訂單與持股查詢（v4.0）**
- **處理成交回報與訂單狀態（v4.1 新增）**
- 支援 Context Manager 模式 (with 語句)

**設計模式：**
- **Facade Pattern (外觀模式)**：簡化 Shioaji API 的複雜介面
- **Context Manager Pattern**：支援資源自動管理

**SOLID 原則體現：**
1. **單一職責原則 (SRP)**：專注於連線管理，不處理交易邏輯
2. **開放封閉原則 (OCP)**：可透過繼承擴展功能，無需修改原有程式碼
3. **依賴反轉原則 (DIP)**：依賴於 Shioaji 抽象介面，而非具體實作

---

### 時序圖：登入流程

```mermaid
sequenceDiagram
    participant User as 使用者
    participant Connector as ShioajiConnector
    participant API as Shioaji API
    participant Logger as Logger
    
    User->>Connector: __init__(api_key, secret_key)
    Connector->>API: 建立 Shioaji 實例
    Connector->>Logger: 記錄初始化成功
    
    User->>Connector: login(person_id, passwd)
    Connector->>Connector: 驗證參數
    Connector->>API: login(credentials)
    API-->>Connector: 返回帳戶資訊
    Connector->>Connector: 更新連線狀態
    Connector->>Logger: 記錄登入成功
    Connector-->>User: 返回 True
    
    opt 如果提供憑證
        Connector->>API: activate_ca(ca_path, ca_passwd)
        API-->>Connector: 憑證啟用成功
        Connector->>Logger: 記錄憑證啟用
    end
    
    opt 如果下載商品檔
        Connector->>API: 取得 Contracts
        API-->>Connector: 返回商品檔資料
        Connector->>Connector: 儲存至 contracts 屬性
        Connector->>Logger: 記錄商品檔載入完成
    end
```

---

### 狀態圖：連線狀態管理

```mermaid
stateDiagram-v2
    [*] --> 未初始化
    未初始化 --> 已初始化: __init__()
    已初始化 --> 已連線: login() 成功
    已初始化 --> 登入失敗: login() 失敗
    登入失敗 --> 已初始化: 重試
    已連線 --> 已初始化: logout()
    已連線 --> [*]: __exit__()
    
    note right of 已連線
        此狀態下可以：
        - 查詢帳戶資訊
        - 查詢市場資料
        - 查詢商品檔 (v2.0)
        - 訂閱即時報價 (v3.0)
        - 執行證券下單 (v4.0)
        - 管理訂單與持股 (v4.0)
    end note
```

---

### 報價訂閱與 Callback 時序圖（v3.0 新增）

```mermaid
sequenceDiagram
    participant User as 使用者
    participant Connector as ShioajiConnector
    participant Shioaji as Shioaji API
    participant Callback as Callback Handler
    participant Logger as Logger
    
    User->>Connector: set_quote_callback(handler)
    Connector->>Connector: 註冊 callback 函數
    Connector->>Shioaji: 設定 on_tick_stk_v1
    Connector->>Logger: 記錄 callback 註冊
    
    User->>Connector: subscribe_quote(contract, "tick")
    Connector->>Connector: 檢查連線狀態
    Connector->>Shioaji: quote.subscribe(contract)
    Shioaji-->>Connector: 訂閱成功
    Connector->>Connector: 記錄已訂閱商品
    Connector->>Logger: 記錄訂閱成功
    Connector-->>User: 返回 True
    
    loop 報價更新
        Shioaji->>Connector: 推送即時報價
        Connector->>Connector: 更新 quote_data
        Connector->>Callback: 呼叫所有註冊的 callback
        Callback->>User: 處理報價資料
        Callback->>Logger: 記錄處理結果
    end
    
    User->>Connector: get_latest_quote(code)
    Connector->>Connector: 查詢 quote_data
    Connector-->>User: 返回最新報價
    
    User->>Connector: unsubscribe_quote(contract)
    Connector->>Shioaji: quote.unsubscribe(contract)
    Shioaji-->>Connector: 取消訂閱成功
    Connector->>Connector: 移除訂閱記錄
    Connector->>Logger: 記錄取消訂閱
```

---

### 使用案例圖

```mermaid
graph TB
    subgraph 量化交易系統
        A[ShioajiConnector<br/>連線管理器]
    end
    
    subgraph 核心功能
        B[登入管理]
        C[憑證認證]
        D[連線監控]
        E[資源釋放]
        H[商品檔管理<br/>v2.0]
        I[商品查詢<br/>v2.0]
        J[報價訂閱<br/>v3.0]
        K[Callback處理<br/>v3.0]
        L[證券下單<br/>v4.0]
        M[訂單管理<br/>v4.0]
        N[成交回報<br/>v4.1 NEW]
        O[訂單狀態<br/>v4.1 NEW]
    end
    
    subgraph 外部依賴
        F[Shioaji API<br/>永豐金證券]
        G[日誌系統<br/>Logger]
    end
    
    A --> B
    A --> C
    A --> D
    A --> E
    A --> H
    A --> I
    A --> J
    A --> K
    A --> L
    A --> M
    A --> N
    A --> O
    
    B --> F
    C --> F
    D --> G
    E --> F
    E --> G
    H --> F
    I --> H
    J --> F
    K --> J
    L --> F
    M --> L
    N --> L
    O --> L
    
    style A fill:#4CAF50,stroke:#2E7D32,color:#fff
    style F fill:#2196F3,stroke:#1565C0,color:#fff
    style G fill:#FF9800,stroke:#E65100,color:#fff
    style H fill:#4CAF50,stroke:#2E7D32,color:#fff
    style I fill:#4CAF50,stroke:#2E7D32,color:#fff
    style J fill:#E91E63,stroke:#880E4F,color:#fff
    style K fill:#E91E63,stroke:#880E4F,color:#fff
    style L fill:#9C27B0,stroke:#4A148C,color:#fff
    style M fill:#9C27B0,stroke:#4A148C,color:#fff
    style N fill:#FF5722,stroke:#BF360C,color:#fff
    style O fill:#FF5722,stroke:#BF360C,color:#fff
```

---

### 模組便利函數

```mermaid
graph LR
    A[create_connector] -->|建立| B[ShioajiConnector]
    A -->|參數| C[api_key]
    A -->|參數| D[secret_key]
    A -->|參數| E[simulation]
    
    style A fill:#9C27B0,stroke:#6A1B9A,color:#fff
    style B fill:#4CAF50,stroke:#2E7D32,color:#fff
```

---

### 商品檔查詢時序圖（新增功能）

```mermaid
sequenceDiagram
    participant User as 使用者
    participant Connector as ShioajiConnector
    participant Contracts as Contracts
    participant Logger as Logger
    
    User->>Connector: search_stock("2330")
    Connector->>Connector: 檢查連線狀態
    Connector->>Connector: 檢查 contracts 是否存在
    Connector->>Contracts: 遍歷 Stocks
    Contracts-->>Connector: 返回符合條件的股票列表
    Connector->>Logger: 記錄搜尋結果
    Connector-->>User: 返回股票合約列表
    
    User->>Connector: get_stock_by_code("2330")
    Connector->>Connector: 檢查連線狀態
    Connector->>Contracts: 使用代碼精確查詢
    Contracts-->>Connector: 返回股票合約
    Connector->>Logger: 記錄查詢結果
    Connector-->>User: 返回股票合約物件
    
    User->>Connector: get_contracts_summary()
    Connector->>Contracts: 統計各類商品數量
    Contracts-->>Connector: 返回統計數據
    Connector->>Logger: 記錄統計資訊
    Connector-->>User: 返回統計字典
```

---

### 商品檔功能架構圖（新增）

```mermaid
graph TB
    subgraph ShioajiConnector
        A[contracts 屬性]
        B[get_contracts]
        C[search_stock]
        D[get_stock_by_code]
        E[search_futures]
        F[get_contracts_summary]
    end
    
    subgraph Contracts Object
        G[Stocks<br/>股票商品]
        H[Futures<br/>期貨商品]
        I[Options<br/>選擇權商品]
    end
    
    subgraph 使用場景
        J[查詢股票資訊]
        K[查詢期貨資訊]
        L[統計商品數量]
        M[搜尋特定商品]
    end
    
    A --> G
    A --> H
    A --> I
    
    B --> A
    C --> G
    D --> G
    E --> H
    F --> A
    
    C --> J
    D --> J
    E --> K
    F --> L
    C --> M
    E --> M
    
    style A fill:#FF9800,stroke:#E65100,color:#fff
    style B fill:#4CAF50,stroke:#2E7D32,color:#fff
    style C fill:#4CAF50,stroke:#2E7D32,color:#fff
    style D fill:#4CAF50,stroke:#2E7D32,color:#fff
    style E fill:#4CAF50,stroke:#2E7D32,color:#fff
    style F fill:#4CAF50,stroke:#2E7D32,color:#fff
```

---

## 設計特點總結

### 1. 符合 SOLID 原則
- ✅ **S (Single Responsibility)**：單一職責，專注連線管理
- ✅ **O (Open/Closed)**：開放擴展，封閉修改
- ✅ **L (Liskov Substitution)**：可被子類別替換
- ✅ **I (Interface Segregation)**：介面精簡，方法職責明確
- ✅ **D (Dependency Inversion)**：依賴抽象而非具體實作

### 2. 良好的錯誤處理
- 所有公開方法都有完整的錯誤處理
- 使用自訂異常提供清晰的錯誤訊息
- 完整的日誌記錄便於問題追蹤

### 3. 完整的文件
- 每個方法都有詳細的 docstring
- 包含參數說明、返回值、異常、使用範例
- 符合 Python 文件規範

### 4. 易用性設計
- 支援 Context Manager (with 語句)
- 提供便利函數 `create_connector`
- 清晰的狀態管理和查詢介面
- **多種商品查詢方式（關鍵字搜尋、精確查詢）**
- **直接訪問 contracts 屬性進行進階操作**

### 5. 可測試性
- 職責單一，易於單元測試
- 依賴注入設計，便於 Mock
- 清晰的狀態轉換邏輯

---

## 未來擴展方向

```mermaid
graph TB
    A[ShioajiConnector<br/>當前實作] --> B[訂單管理器<br/>OrderManager]
    A --> C[帳戶管理器<br/>AccountManager]
    A --> D[市場資料管理器<br/>MarketDataManager]
    A --> E[策略執行器<br/>StrategyExecutor]
    
    B --> F[交易系統整合<br/>Trading System]
    C --> F
    D --> F
    E --> F
    
    style A fill:#4CAF50,stroke:#2E7D32,color:#fff
    style F fill:#FF5722,stroke:#D84315,color:#fff
```

---

---

### 報價訂閱架構圖（v3.0 新增）

```mermaid
graph TB
    subgraph ShioajiConnector 報價管理
        A[subscribed_contracts<br/>已訂閱商品]
        B[quote_callbacks<br/>回調函數]
        C[quote_data<br/>最新報價]
        
        D[subscribe_quote<br/>訂閱報價]
        E[unsubscribe_quote<br/>取消訂閱]
        F[set_quote_callback<br/>設定回調]
        G[get_latest_quote<br/>取得最新報價]
        H[clear_quote_callbacks<br/>清除回調]
    end
    
    subgraph Shioaji API
        I[quote.subscribe<br/>訂閱API]
        J[on_tick_stk_v1<br/>Tick事件]
        K[on_bidask_stk_v1<br/>五檔事件]
    end
    
    subgraph 使用者程式
        L[訂閱商品]
        M[註冊處理函數]
        N[接收報價更新]
        O[查詢最新快照]
    end
    
    L --> D
    M --> F
    N --> B
    O --> G
    
    D --> I
    F --> J
    F --> K
    
    I --> C
    J --> B
    K --> B
    
    D --> A
    G --> C
    
    style A fill:#FFC107,stroke:#F57C00,color:#000
    style B fill:#FFC107,stroke:#F57C00,color:#000
    style C fill:#FFC107,stroke:#F57C00,color:#000
    style D fill:#E91E63,stroke:#880E4F,color:#fff
    style E fill:#E91E63,stroke:#880E4F,color:#fff
    style F fill:#E91E63,stroke:#880E4F,color:#fff
    style G fill:#E91E63,stroke:#880E4F,color:#fff
    style H fill:#E91E63,stroke:#880E4F,color:#fff
```

---

## 版本更新記錄

## v4.1 更新內容（2025-10-06）

### 新增功能：成交回報與訂單狀態監控

#### 1. 新增屬性

| 屬性名稱 | 類型 | 說明 |
|---------|------|------|
| `deal_callbacks` | List[Callable] | 成交回調函數列表 |
| `order_update_callbacks` | List[Callable] | 訂單狀態更新回調函數列表 |
| `deals_history` | List[Dict[str, Any]] | 成交歷史記錄列表 |
| `order_updates` | List[Dict[str, Any]] | 訂單更新記錄列表 |

#### 2. 新增方法

| 方法名稱 | 功能說明 | 返回類型 |
|---------|---------|----------|
| `set_order_callback(callback)` | 設定訂單狀態更新回調 | None |
| `set_deal_callback(callback)` | 設定成交回報回調 | None |
| `get_deals_history()` | 取得成交歷史記錄 | List[Dict] |
| `get_order_updates()` | 取得訂單更新記錄 | List[Dict] |

#### 3. 訂單狀態類型

- **PendingSubmit**: 預備傳送
- **PreSubmitted**: 預先提交
- **Submitted**: 已委託
- **Failed**: 下單失敗
- **Cancelled**: 已取消
- **Filled**: 全部成交
- **Filling**: 部分成交

#### 4. 使用範例

```python
# 登入並啟用憑證
connector = ShioajiConnector(simulation=True)
connector.login(
    person_id="ID",
    passwd="PWD",
    ca_path="/path/to/cert.pfx",
    ca_passwd="cert_pwd"
)

# 設定訂單狀態回調
def order_handler(stat):
    print(f"訂單狀態: {stat.status}")
    print(f"已成交: {stat.deal_quantity} 股")

connector.set_order_callback(order_handler)

# 設定成交回報回調
def deal_handler(deal):
    print(f"成交: {deal.code} {deal.price} x {deal.quantity}")

connector.set_deal_callback(deal_handler)

# 下單
stock = connector.get_stock_by_code("2330")
connector.place_order(stock, "Buy", 600.0, 1000)

# 回調會自動被觸發...

# 查詢歷史
deals = connector.get_deals_history()
for deal in deals:
    print(f"{deal['code']}: {deal['price']} x {deal['quantity']}")

updates = connector.get_order_updates()
for update in updates:
    print(f"{update['order_id']}: {update['status']}")
```

#### 5. 成交回報時序圖

```mermaid
sequenceDiagram
    participant User as 使用者
    participant Connector as ShioajiConnector
    participant Shioaji as Shioaji API
    participant Exchange as 交易所
    participant Callback as Callback Handler
    
    User->>Connector: set_order_callback(handler)
    Connector->>Shioaji: 註冊 on_order_status
    
    User->>Connector: set_deal_callback(handler)
    Connector->>Shioaji: 註冊 on_deal
    
    User->>Connector: place_order(contract, ...)
    Connector->>Shioaji: place_order
    Shioaji->>Exchange: 傳送委託
    Exchange-->>Shioaji: 委託回報
    Shioaji->>Connector: 觸發 order_callback
    Connector->>Callback: 呼叫 order_handler
    Connector->>Connector: 記錄 order_updates
    
    Exchange->>Shioaji: 成交回報
    Shioaji->>Connector: 觸發 deal_callback
    Connector->>Callback: 呼叫 deal_handler
    Connector->>Connector: 記錄 deals_history
    
    Exchange->>Shioaji: 訂單狀態更新
    Shioaji->>Connector: 觸發 order_callback
    Connector->>Callback: 呼叫 order_handler
```

#### 6. 設計考量

- **事件驅動**：使用 callback 機制處理異步事件
- **多 Callback 支援**：可註冊多個處理函數
- **錯誤隔離**：單一 callback 錯誤不影響其他
- **完整記錄**：自動儲存所有成交和更新
- **易於查詢**：提供歷史查詢方法
- **日誌完整**：詳細記錄所有事件

---

## v4.0 更新內容（2025-10-06）

### 新增功能：證券下單與訂單管理

#### 1. 新增屬性

| 屬性名稱 | 類型 | 說明 |
|---------|------|------|
| `order_callbacks` | Dict[str, List[Callable]] | 下單回調函數字典 |
| `orders_history` | List[Dict[str, Any]] | 下單歷史記錄列表 |

#### 2. 新增方法

| 方法名稱 | 功能說明 | 返回類型 |
|---------|---------|----------|
| `place_order(contract, action, price, quantity, ...)` | 下單買賣股票 | Trade |
| `cancel_order(trade)` | 取消訂單 | bool |
| `update_order(trade, price, quantity)` | 修改訂單 | Trade |
| `list_positions()` | 查詢持股明細 | List[Position] |
| `list_trades()` | 查詢今日委託明細 | List[Trade] |
| `get_orders_history()` | 取得下單歷史記錄 | List[Dict] |

#### 3. 支援的下單類型

**委託類型（Order Type）：**
- **ROD** (Rest of Day): 當日有效單，未成交部分當日收盤前有效
- **IOC** (Immediate or Cancel): 立即成交否則取消，無法立即成交的部分取消
- **FOK** (Fill or Kill): 全部成交否則取消，無法全部成交則整筆取消

**價格類型（Price Type）：**
- **LMT** (Limit): 限價單，指定價格下單
- **MKT** (Market): 市價單，以市場價格成交

**交易類型：**
- **整股**: 數量必須為 1000 的倍數
- **盤中零股**: 數量小於 1000 股

#### 4. 使用範例

```python
# 登入並啟用憑證（下單需要憑證）
connector = ShioajiConnector(simulation=True)
connector.login(
    person_id="ID",
    passwd="PWD",
    ca_path="/path/to/cert.pfx",
    ca_passwd="cert_pwd"
)

# 限價買入整股
stock = connector.get_stock_by_code("2330")
trade = connector.place_order(
    contract=stock,
    action="Buy",
    price=600.0,
    quantity=1000,
    order_type="ROD",
    price_type="LMT"
)

# 買入零股
trade = connector.place_order(
    contract=stock,
    action="Buy",
    price=600.0,
    quantity=100,
    odd_lot=True
)

# 市價買入
trade = connector.place_order(
    contract=stock,
    action="Buy",
    price=0,  # 市價單價格設 0
    quantity=1000,
    price_type="MKT"
)

# 取消訂單
connector.cancel_order(trade)

# 修改訂單
new_trade = connector.update_order(trade, price=605.0, quantity=2000)

# 查詢持股
positions = connector.list_positions()

# 查詢委託
trades = connector.list_trades()
```

#### 5. 下單流程時序圖

```mermaid
sequenceDiagram
    participant User as 使用者
    participant Connector as ShioajiConnector
    participant Shioaji as Shioaji API
    participant Broker as 證券商
    participant Logger as Logger
    
    User->>Connector: place_order(contract, action, price, quantity)
    Connector->>Connector: 驗證參數
    Connector->>Connector: 檢查連線狀態
    Connector->>Connector: 建立 Order 物件
    Connector->>Shioaji: place_order(contract, order)
    Shioaji->>Broker: 傳送委託
    Broker-->>Shioaji: 返回委託結果
    Shioaji-->>Connector: 返回 Trade 物件
    Connector->>Connector: 記錄下單歷史
    Connector->>Logger: 記錄下單成功
    Connector-->>User: 返回 Trade
    
    opt 取消訂單
        User->>Connector: cancel_order(trade)
        Connector->>Shioaji: cancel_order(trade)
        Shioaji->>Broker: 傳送取消要求
        Broker-->>Shioaji: 確認取消
        Shioaji-->>Connector: 取消成功
        Connector->>Logger: 記錄取消成功
        Connector-->>User: 返回 True
    end
    
    opt 修改訂單
        User->>Connector: update_order(trade, price, quantity)
        Connector->>Shioaji: update_order(trade, price, qty)
        Shioaji->>Broker: 傳送修改要求
        Broker-->>Shioaji: 返回新委託
        Shioaji-->>Connector: 返回新 Trade
        Connector->>Logger: 記錄修改成功
        Connector-->>User: 返回新 Trade
    end
```

#### 6. 訂單狀態圖

```mermaid
stateDiagram-v2
    [∗] --> 建立訂單
    建立訂單 --> 傳送中: place_order()
    傳送中 --> 已委託: 下單成功
    傳送中 --> 下單失敗: 錯誤
    下單失敗 --> [∗]
    
    已委託 --> 部分成交: 市場匹配
    已委託 --> 全部成交: 市場匹配
    已委託 --> 已取消: cancel_order()
    已委託 --> 已修改: update_order()
    
    部分成交 --> 全部成交: 繼續匹配
    部分成交 --> 已取消: cancel_order()
    
    已修改 --> 已委託: 新訂單
    
    全部成交 --> [∗]
    已取消 --> [∗]
    
    note right of 已委託
        此狀態下可以：
        - 取消訂單
        - 修改訂單
        - 等待成交
    end note
```

#### 7. 設計考量

- **安全性**：完整的參數驗證和錯誤處理
- **封裝性**：隱藏 Shioaji Order 物件的複雜度
- **靈活性**：支援整股、零股、限價、市價等多種類型
- **可追蹤**：自動記錄下單歷史供後續分析
- **錯誤隔離**：下單失敗不影響系統運作
- **日誌完整**：所有下單操作都有詳細日誌

---

## v3.0 更新內容（2025-10-06）

### 新增功能：即時報價訂閱與 Callback 處理

#### 1. 新增屬性

| 屬性名稱 | 類型 | 說明 |
|---------|------|------|
| `subscribed_contracts` | Dict[str, Any] | 已訂閱的商品字典 |
| `quote_callbacks` | Dict[str, List[Callable]] | 報價回調函數字典 |
| `quote_data` | Dict[str, Any] | 最新報價資料快照 |

#### 2. 新增方法

| 方法名稱 | 功能說明 | 返回類型 |
|---------|---------|----------|
| `subscribe_quote(contract, quote_type)` | 訂閱即時報價 | bool |
| `unsubscribe_quote(contract)` | 取消訂閱報價 | bool |
| `set_quote_callback(callback, event_type)` | 設定報價回調函數 | None |
| `get_subscribed_contracts()` | 取得已訂閱商品列表 | Dict |
| `get_latest_quote(code)` | 取得最新報價快照 | Dict |
| `clear_quote_callbacks(event_type)` | 清除回調函數 | None |

#### 3. 支援的報價類型

- **tick**: 逐筆成交報價，包含每筆交易的價格、成交量等資訊
- **bidask**: 五檔委買委賣報價，包含買賣五檔的價格和數量

#### 4. 使用範例

```python
# 登入並註冊 callback
connector = ShioajiConnector(simulation=True)
connector.login(person_id="ID", passwd="PWD")

# 定義報價處理函數
def quote_handler(topic, quote):
    print(f"商品: {topic}")
    print(f"價格: {quote['close']}")
    print(f"成交量: {quote['volume']}")

# 註冊 callback
connector.set_quote_callback(quote_handler, "tick")

# 訂閱股票
stock = connector.get_stock_by_code("2330")
connector.subscribe_quote(stock, "tick")

# 接收報價更新...
# callback 會自動被呼叫

# 查詢最新報價
latest = connector.get_latest_quote("2330")
print(f"最新價格: {latest['close']}")

# 取消訂閱
connector.unsubscribe_quote(stock)
```

#### 5. Callback 機制特點

- **多個 Callback 支援**：可以為同一事件註冊多個 callback 函數
- **異步處理**：Callback 在報價更新時由 Shioaji 異步呼叫
- **錯誤隔離**：單一 callback 錯誤不影響其他 callback
- **資料快照**：自動儲存最新報價供查詢

#### 6. 設計考量

- **事件驅動設計**：使用 callback 機制處理即時事件
- **資料封裝**：隱藏 Shioaji API 的複雜度
- **靈活性**：支援多種報價類型和多個 callback
- **安全性**：完整的錯誤處理和日誌記錄
- **效能考量**：Callback 應快速執行，避免阻塞

---

## v2.0 更新內容（2025-10-06）

### 新增功能：商品檔管理與查詢

#### 1. 新增屬性
- `contracts` (Contracts): 儲存所有可交易商品的資料物件

#### 2. 新增方法

| 方法名稱 | 功能說明 | 返回類型 |
|---------|---------|----------|
| `get_contracts()` | 取得所有商品檔物件 | Contracts |
| `search_stock(keyword)` | 使用關鍵字搜尋股票 | List[Contract] |
| `get_stock_by_code(code)` | 精確查詢特定股票代碼 | Contract |
| `search_futures(keyword)` | 使用關鍵字搜尋期貨 | List[Contract] |
| `get_contracts_summary()` | 取得商品統計摘要 | Dict[str, int] |

#### 3. 使用範例

```python
# 登入並載入商品檔
connector = ShioajiConnector(simulation=True)
connector.login(person_id="ID", passwd="PWD", fetch_contract=True)

# 搜尋股票
stocks = connector.search_stock("2330")
for stock in stocks:
    print(f"{stock.code} {stock.name}")

# 精確查詢
stock = connector.get_stock_by_code("2330")
print(f"股票: {stock.code} {stock.name}")

# 查看統計
summary = connector.get_contracts_summary()
print(f"股票數量: {summary['stocks']}")

# 直接使用 contracts
all_stocks = connector.contracts.Stocks
```

#### 4. 設計考量

- **單一職責延伸**：商品檔管理屬於連線管理的延伸，符合類別職責
- **封裝性**：提供高階查詢方法，隱藏底層複雜度
- **靈活性**：同時支援高階方法和直接訪問 contracts
- **錯誤處理**：完整的連線狀態和商品檔載入檢查
- **效能考量**：登入時一次性載入，避免重複查詢

---

**文件版本：** 4.1  
**建立日期：** 2025-10-06  
**作者：** Trading System Team  
**最後更新：** 2025-10-06 (v4.1 新增成交回報功能)
