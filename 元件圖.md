# 永豐金證券股票回測系統 - 元件圖

## 系統元件架構

```mermaid
graph TB
    subgraph "應用層"
        APP[應用程式]
    end
    
    subgraph "業務邏輯層"
        CLIENT[SinotradeClient<br/>永豐金客戶端]
        AUTH[AuthenticationService<br/>認證服務]
        FETCHER[MarketDataFetcher<br/>市場資料抓取器]
        STORAGE[BigQueryStorage<br/>BigQuery 儲存服務]
        VALIDATOR[DataValidator<br/>資料驗證器]
    end
    
    subgraph "資料模型層"
        LOGIN_CRED[LoginCredentials<br/>登入憑證]
        DATE_RANGE[DateRange<br/>日期區間]
    end
    
    subgraph "外部服務層"
        SHIOAJI[Shioaji API<br/>永豐金證券 API]
        BIGQUERY[Google BigQuery<br/>雲端資料倉儲]
    end
    
    %% 應用層與業務邏輯層
    APP --> CLIENT
    APP --> FETCHER
    APP --> STORAGE
    APP --> VALIDATOR
    
    %% 業務邏輯層內部關係
    CLIENT --> AUTH
    FETCHER --> DATE_RANGE
    VALIDATOR --> STORAGE
    
    %% 資料模型層
    AUTH --> LOGIN_CRED
    
    %% 業務邏輯層與外部服務層
    CLIENT --> SHIOAJI
    AUTH --> SHIOAJI
    FETCHER --> SHIOAJI
    STORAGE --> BIGQUERY
    
    %% 樣式定義
    classDef appStyle fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    classDef businessStyle fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef dataStyle fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef externalStyle fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    
    class APP appStyle
    class CLIENT,AUTH,FETCHER,STORAGE,VALIDATOR businessStyle
    class LOGIN_CRED,DATE_RANGE dataStyle
    class SHIOAJI,BIGQUERY externalStyle
```

## 元件職責說明

### 應用層

#### 應用程式（Application）
**職責**：系統的主要入口點
- 協調各個業務邏輯元件
- 處理使用者輸入和輸出
- 控制整體工作流程

### 業務邏輯層

#### SinotradeClient（永豐金客戶端）
**職責**：提供永豐金證券 API 的統一介面
- 管理 API 連線生命週期
- 提供帳號管理功能
- 整合認證服務
- 對外提供高層級的 API 操作

#### AuthenticationService（認證服務）
**職責**：處理使用者身份驗證
- 執行登入和登出操作
- 管理登入狀態
- 驗證使用者憑證

#### MarketDataFetcher（市場資料抓取器）
**職責**：從永豐金證券抓取市場資料
- 取得股票列表
- 抓取歷史 K 線資料
- 批量處理多支股票
- 資料格式轉換

#### BigQueryStorage（BigQuery 儲存服務）
**職責**：管理 BigQuery 資料存取
- 建立和維護資料表
- 上傳資料到 BigQuery
- 執行資料查詢
- 管理資料表分區和叢集

#### DataValidator（資料驗證器）
**職責**：驗證資料完整性和品質
- 檢查資料是否存在
- 驗證資料完整性
- 檢查資料品質
- 提供資料摘要統計

### 資料模型層

#### LoginCredentials（登入憑證）
**職責**：封裝登入資訊
- 儲存身份證字號和密碼
- 驗證憑證格式

#### DateRange（日期區間）
**職責**：封裝日期範圍
- 儲存開始和結束日期
- 驗證日期邏輯

### 外部服務層

#### Shioaji API（永豐金證券 API）
**職責**：提供證券交易功能
- 使用者認證
- 帳號管理
- 取得市場資料
- 執行交易操作

#### Google BigQuery（雲端資料倉儲）
**職責**：提供大數據儲存和查詢
- 儲存海量交易資料
- 支援快速查詢
- 提供資料分析功能

## 資料流程

### 1. 使用者認證流程

```mermaid
sequenceDiagram
    participant APP as 應用程式
    participant CLIENT as SinotradeClient
    participant AUTH as AuthenticationService
    participant SHIOAJI as Shioaji API
    
    APP->>CLIENT: login(person_id, passwd)
    CLIENT->>AUTH: login(credentials)
    AUTH->>SHIOAJI: login()
    SHIOAJI-->>AUTH: 認證結果
    AUTH-->>CLIENT: 登入狀態
    CLIENT-->>APP: 登入成功
```

### 2. 資料抓取流程

```mermaid
sequenceDiagram
    participant APP as 應用程式
    participant FETCHER as MarketDataFetcher
    participant SHIOAJI as Shioaji API
    
    APP->>FETCHER: fetch_all_market_kbars(date_range)
    FETCHER->>SHIOAJI: get stock list
    SHIOAJI-->>FETCHER: stock symbols
    
    loop 每支股票
        FETCHER->>SHIOAJI: kbars(contract, start, end)
        SHIOAJI-->>FETCHER: K線資料
    end
    
    FETCHER-->>APP: DataFrame (所有股票資料)
```

### 3. 資料儲存流程

```mermaid
sequenceDiagram
    participant APP as 應用程式
    participant STORAGE as BigQueryStorage
    participant BIGQUERY as Google BigQuery
    
    APP->>STORAGE: insert_dataframe(df)
    STORAGE->>STORAGE: 驗證資料格式
    STORAGE->>BIGQUERY: create_table_if_not_exists()
    BIGQUERY-->>STORAGE: 資料表已就緒
    STORAGE->>BIGQUERY: load_table_from_dataframe()
    BIGQUERY-->>STORAGE: 上傳完成
    STORAGE-->>APP: 插入筆數
```

### 4. 資料驗證流程

```mermaid
sequenceDiagram
    participant APP as 應用程式
    participant VALIDATOR as DataValidator
    participant STORAGE as BigQueryStorage
    participant BIGQUERY as Google BigQuery
    
    APP->>VALIDATOR: validate_data_quality()
    VALIDATOR->>STORAGE: query_data(validation_sql)
    STORAGE->>BIGQUERY: query()
    BIGQUERY-->>STORAGE: 查詢結果
    STORAGE-->>VALIDATOR: DataFrame
    VALIDATOR->>VALIDATOR: 分析資料品質
    VALIDATOR-->>APP: 驗證報告
```

## 完整工作流程

```mermaid
graph LR
    A[開始] --> B[登入系統]
    B --> C[抓取市場資料]
    C --> D[儲存到 BigQuery]
    D --> E[驗證資料]
    E --> F{資料完整?}
    F -->|是| G[結束]
    F -->|否| H[記錄缺失]
    H --> I[重新抓取]
    I --> D
    
    style A fill:#e1f5ff
    style G fill:#e8f5e9
    style F fill:#fff3e0
    style H fill:#ffebee
```

## 系統特性

### 模組化設計
- 每個元件都有明確的職責
- 元件之間低耦合、高內聚
- 易於測試和維護

### 可擴展性
- 可以輕鬆添加新的資料來源
- 支援不同的儲存後端
- 驗證規則可以靈活配置

### 可靠性
- 完整的錯誤處理機制
- 資料驗證確保品質
- 日誌記錄便於追蹤問題

### 效能考量
- BigQuery 資料表使用分區和叢集優化查詢
- 批量處理減少 API 呼叫次數
- 非同步處理提升效率（未來可擴展）

## 部署架構

```mermaid
graph TB
    subgraph "本地環境"
        LOCAL[Python 應用程式]
    end
    
    subgraph "雲端服務"
        GCP[Google Cloud Platform]
        BQ[(BigQuery)]
        AUTH_SVC[認證服務]
    end
    
    subgraph "外部服務"
        SINO[永豐金證券伺服器]
    end
    
    LOCAL -->|API 呼叫| SINO
    LOCAL -->|資料上傳| BQ
    LOCAL -->|服務帳號認證| AUTH_SVC
    
    BQ --> GCP
    AUTH_SVC --> GCP
```

## 安全性考量

### 認證管理
- 使用環境變數儲存敏感資訊
- 支援 GCP 服務帳號認證
- 不在程式碼中硬編碼密碼

### 資料安全
- BigQuery 資料加密
- 使用 IAM 控制存取權限
- 網路傳輸使用 HTTPS

### 錯誤處理
- 捕捉具體的錯誤類型
- 記錄詳細的錯誤資訊
- 不洩漏敏感資訊到日誌
